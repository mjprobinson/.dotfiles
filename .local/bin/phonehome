#!/usr/bin/bash

HOME_SSID="You Know You Want This"
MR_SERVER_USER=mr
MR_SERVER_ADDR=mr.home
MR_SERVER_MAC=58:11:22:e4:c8:55
WIREGUARD_VPN_CONF=home

function set_up_terminal () {
	kitty @ set-tab-title ssh
	kitty @ set-colors ~/.config/kitty/catppuccin-mocha.conf
	kitty @ launch --no-response --keep-focus --type=tab --color ~/.config/kitty/catppuccin-frappe.conf --title "local"
}

function vpn () {
	ssid=$(iwgetid -r)

	if [[ $ssid != "You Know You Want This" ]]; then
	    echo "Setting up VPN"
	    wg-quick up $WIREGUARD_VPN_CONF
	else
	    echo "You're Home"
	fi
}

function wake_server () {
    wakeonlan $MR_SERVER_MAC
    ping -c 1 $MR_SERVER_ADDR > /dev/null
    server_up=$?

    while [[ $server_up -eq 1 ]]
    do
        sleep 1
        ping -c 1 $MR_SERVER_ADDR > /dev/null
        server_up=$?
    done
}

function wake () {
	if ping -c 1 $MR_SERVER_ADDR > /dev/null; then
	    echo "Server Awake"
	else
	    echo "Waking server"
	    wake_server
	fi
}

function mnt_fs () {
	if [[ $(ls /mnt/mr-server/ | wc -l) > 0 ]]; then
		echo "FS Already Mounted"
	else
		echo "Mounting FS"
		sshfs -o default_permissions -o IdentityFile=~/.ssh/michael-laptop-server $MR_SERVER_USER@$MR_SERVER_ADDR:/home/$MR_SERVER_USER/ /mnt/mr-server/
	fi
}

function ssh_in () {
	echo "SSHing"
	ssh mr-server
}


# Main Start
if [[ $# -eq 0 ]]; then
    set_up_terminal
    vpn
    wake
    mnt_fs
    ssh_in
    exit 0
fi

case $1 in
    -t|--no-term)
    vpn
    wake
    mnt_fs
    ssh_in
    exit 0
esac

while [[ $# -gt 0 ]]; do
    case $1 in
        -v|--vpn)
		    vpn
            shift
            ;;
        -w|--wake)
            wake
            shift
            ;;
        -f|--fs)
            mnt_fs
            shift
            ;;
    esac
done
exit 0
